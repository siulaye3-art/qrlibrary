<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Library Borrower - QR Scanner (Return Mode)</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
<style>
  body{font-family:system-ui, sans-serif; background:#f4f7f9; margin:0; color:#222}
  .app-bar{background:#0a7d32;color:#fff;padding:1rem;display:flex;justify-content:space-between;align-items:center;box-shadow:0 2px 6px rgba(0,0,0,.2)}
  .card{background:#fff;border-radius:12px;padding:1rem;margin:1rem;box-shadow:0 2px 6px rgba(0,0,0,.08)}
  .row{display:flex;gap:.5rem}
  .btn{padding:.5rem .9rem;border-radius:8px;border:0;cursor:pointer;font-weight:600}
  .btn.primary{background:#0a7d32;color:#fff}
  .btn.outline{background:#fff;border:1px solid #0a7d32;color:#0a7d32}
  .btn.danger{background:#e74c3c;color:#fff}
  video{width:100%;border-radius:12px;background:#000}
  .overlay{position:absolute;top:8px;left:8px;background:rgba(0,0,0,.6);color:#fff;padding:.4rem .6rem;border-radius:6px;font-size:.9rem}
  .video-wrap{position:relative;}
  #scan-line{position:absolute;left:0;width:100%;height:2px;background:red;animation:scanAnim 2s infinite alternate;display:none}
  @keyframes scanAnim{from{top:0%}to{top:100%}}
  .chip{display:inline-block;padding:.25rem .5rem;background:#eee;border-radius:6px;margin:.15rem}
  dialog{border:none;border-radius:12px;padding:1rem;width:90%;max-width:520px}
  .muted{color:#666}
  #toast {
  position: fixed;
  top: 1rem;        /* move from bottom to top */
  left: 50%;
  transform: translateX(-50%);
  background: #0a7d32;
  color: #fff;
  padding: .7rem 1rem;
  border-radius: 8px;
  opacity: 0;
  transition: opacity .25s;
  z-index: 9999;    /* ensure it appears above other elements */
}
#toast.show {
  opacity: 1;
}

  .return-panel{background:#fff;padding:.75rem;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-top:.6rem}
  .return-list{display:flex;flex-wrap:wrap;gap:.5rem}
  .progress-dot{width:10px;height:10px;border-radius:50%;display:inline-block;margin-left:.5rem}
  .progress-dot.done{background:green}
  .progress-dot.todo{background:#ccc}
/* Bottom nav bar */
/* Bottom nav bar - hanging style */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #fff;
  border-top: 1px solid #ddd;
  display: flex;
  justify-content: space-around;
  align-items: center;
  padding: 0.5rem 0;
  box-shadow: 0 -4px 12px rgba(0,0,0,0.15); /* stronger shadow for hanging effect */
  z-index: 10000; /* ensure it's above everything */
  border-radius: 12px 12px 0 0; /* rounded top edges */
}

/* Add bottom padding to main content so it doesn't go under the nav */
main {
  padding-bottom: 70px; /* equal or slightly more than bottom-nav height */
}

.bottom-nav button {
  flex: 1;
  background: none;
  border: none;
  color: #0a7d32;
  font-size: 0.9rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 0.25rem;
  cursor: pointer;
}

.bottom-nav button:disabled {
  color: #999;
}

.bottom-nav i {
  font-size: 1.3rem;
}
.card {
  background:#fff;
  border-radius:12px;
  padding:1rem;
  margin:0.5rem 0;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  word-wrap: break-word; /* allow long text to wrap */
  white-space: normal;   /* prevent text cutoff */
  width: 100%;           /* full width inside container */
  box-sizing: border-box;
}
/* Decrease text size of borrower records */
#recordsList li {
    font-size: 0.85rem;
    line-height: 1.2;
}

#recordsList li .muted.small {
    font-size: 0.75rem;
}
/* Smaller search bar */
#searchRecords {
    font-size: 0.85rem;  /* smaller text */
    padding: 0.4rem 0.6rem; /* smaller padding */
}
.video-wrap {
  position: relative;
  width: 300px;   /* reduced width */
  height: 200px;  /* reduced height */
  margin: auto;
  overflow: hidden;
  border: 2px solid #0a7d32;
  border-radius: 12px;
}
video {
  width: 100%;
  height: 100%;
  object-fit: cover;  /* keeps aspect ratio */
  border-radius: 12px;
}
#scan-line {
  position: absolute;
  left: 0;
  width: 100%;
  height: 2px;
  background: red;
  animation: scanAnim 2s infinite alternate;
  display: none;
}
.app-bar {
  background: #0a7d32;
  color: #fff;
  padding: 0.5rem 1rem; /* smaller padding */
  display: flex;
  justify-content: space-between;
  align-items: center;
  box-shadow: 0 2px 6px rgba(0,0,0,.2);
  font-size: 0.9rem; /* smaller text */
}

.app-bar h1 {
  font-size: 1rem; /* smaller heading */
  margin: 0;
}

.app-bar button {
  font-size: 0.8rem; /* smaller button text */
  padding: 0.3rem 0.6rem; /* smaller button */
}



</style>
</head>
<body>
  <header class="app-bar">
    <h1>Library Borrower - QR Scanner</h1>
    <div>
      <button id="btnRecords" class="btn outline"><i class="bi bi-card-list"></i> Records</button>
    </div>
  </header>

  <main>
    <section class="card">
      <h2><i class="bi bi-upc-scan"></i> Scanner</h2>
      <div class="video-wrap">
        <video id="video" autoplay muted playsinline></video>
        <div id="overlay" class="overlay">Ready</div>
        <div id="scan-line"></div>
        <canvas id="frame" style="display:none"></canvas>
      </div>

     <!-- Bottom Navigation Bar for Scanner -->
<div class="bottom-nav">
  <button id="btnStart"><i class="bi bi-camera-video"></i><span>Start</span></button>
  <button id="btnStop" disabled><i class="bi bi-stop-circle"></i><span>Stop</span></button>
  <button id="btnTorch" disabled><i class="bi bi-lightbulb"></i><span>Torch</span></button>
  <button id="btnDone" disabled><i class="bi bi-check2-all"></i><span>Done</span></button>
</div>


      <div style="margin-top:.75rem">
        <strong>Scanned books (for borrow):</strong>
        <div id="scannedList" style="margin-top:.4rem"></div>
      </div>

      <div id="returnModePanel" class="return-panel" style="display:none">
        <div><strong>Return Mode</strong> — Borrower: <span id="returnBorrowerName"></span> (<span id="returnBorrowerId"></span>)</div>
        <div class="muted small" id="returnBorrowerInfo" style="margin-top:.25rem"></div>
        <div style="margin-top:.5rem"><strong>Items to scan:</strong></div>
        <div id="requiredList" class="return-list" style="margin-top:.4rem"></div>
        <div style="margin-top:.6rem">
          <button id="btnCancelReturn" class="btn outline">Cancel Return</button>
          <button id="btnConfirmReturn" class="btn primary" disabled>Confirm Return</button>
        </div>
      </div>

    </section>
  </main>

  <!-- Borrow dialog -->
  <dialog id="dlgBorrow">
    <form id="borrowForm">
      <h3>Borrower Details</h3>
      <div><label>Name</label><input id="bName" required style="width:100%;padding:.4rem;margin:.25rem 0"></div>
      <div style="display:flex;gap:.4rem">
        <input id="bId" placeholder="ID Number" required style="flex:1;padding:.4rem">
        <input id="bPhone" placeholder="Phone" style="flex:1;padding:.4rem">
      </div>
      <div style="display:flex;gap:.4rem;margin-top:.2rem">
        <input id="bEmail" placeholder="Email" required style="flex:1;padding:.4rem">
        <input id="bCourse" placeholder="Course" style="flex:1;padding:.4rem">
      </div>
      <div style="display:flex;gap:.4rem;margin-top:.2rem">
        <input id="bYear" placeholder="Year" style="flex:1;padding:.4rem">
        <input id="bDept" placeholder="Department" style="flex:1;padding:.4rem">
      </div>

      <div style="margin-top:.5rem"><strong>Books to borrow:</strong>
        <div id="dlgScannedList" style="margin-top:.4rem"></div>
      </div>

      <menu style="margin-top:.6rem">
        <button id="btnCancelBorrow" type="button" class="btn outline">Cancel</button>
        <button id="btnConfirmBorrow" type="submit" class="btn primary">Confirm Borrow</button>
      </menu>
    </form>
  </dialog>

  <!-- Records -->
  <!-- Records -->
<dialog id="dlgRecords">
  <h3>Borrower Records</h3>
  <!-- Increased padding from .4rem to .8rem -->
  <input id="searchRecords" placeholder="Search by name, id or book..." style="width:93%;padding:.4rem .6rem;margin:.8rem 0">
  <div id="recordsContainer" style="max-height:320px;overflow:auto">
    <div id="emptyState" class="muted">Loading...</div>
    <ul id="recordsList" style="list-style:none;padding:0"></ul>
  </div>
  <menu style="margin-top:.6rem">
    <button id="btnCloseRecords" class="btn outline">Close</button>
  </menu>
</dialog>


  <div id="toast">toast</div>
  <audio id="beepSound" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg"></audio>

  <!-- jsQR -->
  <script src="https://cdn.jsdelivr.net/npm/jsqr/dist/jsQR.js"></script>

  <script>
  (function(){
    const ENDPOINTS = {
      save: 'save.php',
      get: 'get_record.php',
      itemReturn: 'return.php',
      deleteBorrower: 'delete.php'
    };

    const video = document.getElementById('video');
    const canvas = document.getElementById('frame');
    const ctx = canvas.getContext('2d');
    const overlay = document.getElementById('overlay');
    const btnStart = document.getElementById('btnStart');
    const btnStop = document.getElementById('btnStop');
    const btnTorch = document.getElementById('btnTorch');
    const btnDone = document.getElementById('btnDone');
    const scannedList = document.getElementById('scannedList');
    const dlgBorrow = document.getElementById('dlgBorrow');
    const borrowForm = document.getElementById('borrowForm');
    const dlgScannedList = document.getElementById('dlgScannedList');
    const btnCancelBorrow = document.getElementById('btnCancelBorrow');

    const dlgRecords = document.getElementById('dlgRecords');
    const btnRecords = document.getElementById('btnRecords');
    const btnCloseRecords = document.getElementById('btnCloseRecords');
    const recordsList = document.getElementById('recordsList');
    const searchRecords = document.getElementById('searchRecords');
    const emptyState = document.getElementById('emptyState');

    const returnPanel = document.getElementById('returnModePanel');
    const returnBorrowerName = document.getElementById('returnBorrowerName');
    const returnBorrowerId = document.getElementById('returnBorrowerId');
    const returnBorrowerInfo = document.getElementById('returnBorrowerInfo');
    const requiredList = document.getElementById('requiredList');
    const btnCancelReturn = document.getElementById('btnCancelReturn');
    const btnConfirmReturn = document.getElementById('btnConfirmReturn');

    const toastEl = document.getElementById('toast');
    const beep = document.getElementById('beepSound');

    let stream = null;
    let scanning = false;
    let currentTrack = null;
    let torchOn = false;

    let serverRecords = [];
    let scannedCodes = JSON.parse(localStorage.getItem('scannedCodes')|| '[]');

    let inReturnMode = false;
    let returnRecord = null;
    let returnScanned = new Set();

    function showToast(msg, ms=2000){
      toastEl.textContent = msg;
      toastEl.classList.add('show');
      setTimeout(()=>toastEl.classList.remove('show'), ms);
    }

    async function getJSON(url){
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('HTTP '+res.status);
        return await res.json();
      }catch(err){ console.warn('getJSON error', err); return null; }
    }
    async function postJSON(url, data){
      try{
        const res = await fetch(url, {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(data)
        });
        return await res.json().catch(()=>({ok:false}));
      }catch(err){ console.warn('postJSON err', err); return null; }
    }

    async function loadServerRecords(){
      const data = await getJSON(ENDPOINTS.get);
      if(Array.isArray(data)){
        serverRecords = data;
        saveServerRecordsToLocal();
      } else {
        const local = JSON.parse(localStorage.getItem('serverRecords')||'[]');
        serverRecords = local;
      }
      renderRecordsList();
    }
    function saveServerRecordsToLocal(){
      localStorage.setItem('serverRecords', JSON.stringify(serverRecords));
    }

    function renderScannedList(){
      scannedList.innerHTML = '';
      scannedCodes.forEach(c=>{
        const s = document.createElement('span');
        s.className='chip';
        s.textContent = c;
        scannedList.appendChild(s);
      });
      btnDone.disabled = scannedCodes.length === 0;
      overlay.textContent = inReturnMode ? 'Return mode' : `Scanning... (${scannedCodes.length})`;
    }

    function enterReturnMode(record){
      inReturnMode = true;
      returnRecord = record;
      returnScanned = new Set();
      returnBorrowerName.textContent = record.borrower.name;
      returnBorrowerId.textContent = record.borrower.id || '';
      let info = [];
      if(record.borrower.course) info.push(record.borrower.course);
      if(record.borrower.year) info.push(record.borrower.year);
      returnBorrowerInfo.textContent = info.join(' • ');
      requiredList.innerHTML = '';
      record.books.forEach(code=>{
        const el = document.createElement('div');
        el.className = 'chip';
        el.dataset.code = code;
        el.innerHTML = `<span class="req-code">${code}</span> <span class="progress-dot todo"></span>`;
        requiredList.appendChild(el);
      });
      btnConfirmReturn.disabled = true;
      returnPanel.style.display = 'block';
      overlay.textContent = `Return Mode: ${record.borrower.name}`;
      showToast(`Return mode: ${record.borrower.name}`, 1600);
    }

    function exitReturnMode(){
      inReturnMode = false;
      returnRecord = null;
      returnScanned = new Set();
      requiredList.innerHTML = '';
      returnPanel.style.display = 'none';
      overlay.textContent = `Scanning... (${scannedCodes.length})`;
    }

    function markReturnScanned(code){
      if(!returnRecord) return;
      if(!returnRecord.books.includes(code)) return;
      if(returnScanned.has(code)) return;
      returnScanned.add(code);
      const chip = Array.from(requiredList.querySelectorAll('.chip')).find(n => n.dataset.code === code);
      if(chip){
        const dot = chip.querySelector('.progress-dot');
        if(dot){ dot.classList.remove('todo'); dot.classList.add('done'); }
      }
      if(returnScanned.size === returnRecord.books.length){
        btnConfirmReturn.disabled = false;
        showToast('All items scanned — you can Confirm Return');
      } else {
        const remaining = returnRecord.books.length - returnScanned.size;
        showToast(`${remaining} item(s) left to scan`, 900);
      }
    }

    async function confirmReturn(){
      if(!returnRecord) return;
      const borrowerId = returnRecord.borrower.id || returnRecord.id || null;
      for(const code of Array.from(returnScanned)){
        try{ await postJSON(ENDPOINTS.itemReturn, { code }); }catch(e){}
      }
      try{ await postJSON(ENDPOINTS.deleteBorrower, { borrowerId }); }catch(e){}
      serverRecords = serverRecords.filter(r=>{
        const idA = r.borrower && r.borrower.id ? r.borrower.id : r.id;
        return String(idA) !== String(borrowerId);
      });
      saveServerRecordsToLocal();
      renderRecordsList();
      showToast('Return completed — record removed');
      exitReturnMode();
    }

    function startScan(){
      if(scanning) return;
      navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
        .then(s=>{
          stream = s;
          video.srcObject = stream;
          video.play();
          scanning = true;
          btnStart.disabled = true;
          btnStop.disabled = false;
          document.getElementById('scan-line').style.display = 'block';
          currentTrack = stream.getVideoTracks()[0];
          const caps = currentTrack.getCapabilities ? currentTrack.getCapabilities() : {};
          btnTorch.disabled = !caps.torch;
          overlay.textContent = `Scanning... (${scannedCodes.length})`;
          requestAnimationFrame(scanFrame);
        }).catch(err=>{
          console.error('camera:', err);
          overlay.textContent = 'Camera access required';
          showToast('Allow camera access');
        });
    }

    function stopScan(){
      if(stream) stream.getTracks().forEach(t=>t.stop());
      scanning = false;
      video.srcObject = null;
      btnStart.disabled = false;
      btnStop.disabled = true;
      document.getElementById('scan-line').style.display = 'none';
      overlay.textContent = 'Stopped';
    }

   let lastScannedCode = null; // keep track of last scanned code

function scanFrame(){
  if(!scanning) return;
  if(video.readyState === video.HAVE_ENOUGH_DATA){
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    ctx.drawImage(video,0,0,canvas.width,canvas.height);
    const idata = ctx.getImageData(0,0,canvas.width,canvas.height);
    const code = jsQR(idata.data, idata.width, idata.height, { inversionAttempts: 'dontInvert' });

    if(code && code.data){
      const scannedCode = String(code.data).trim();

      // Only play sound if this code is new or different from the last one
      if(scannedCode !== lastScannedCode){
        beep.currentTime = 0;
        beep.play().catch(()=>{});
        lastScannedCode = scannedCode;
      }

if(inReturnMode && returnRecord){
  if(returnRecord.books.includes(scannedCode)) markReturnScanned(scannedCode);
  else showToast('This item does not belong to ' + returnRecord.borrower.name);
} else {
  const found = serverRecords.find(r => Array.isArray(r.books) && r.books.includes(scannedCode));
  if(found){
    enterReturnMode(found);
    markReturnScanned(scannedCode);
  } else {
    if(!scannedCodes.includes(scannedCode)){
      scannedCodes.push(scannedCode);
      localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
      renderScannedList();
      showToast('Added. Total scanned: ' + scannedCodes.length);
    } else {
      showToast('Already scanned. Total scanned: ' + scannedCodes.length);
    }
  }
}

// Always update overlay with total scanned count
overlay.textContent = `Scanning... (${scannedCodes.length})`;

    } else {
      lastScannedCode = null; // reset if no QR detected
    }
  }
  requestAnimationFrame(scanFrame);
}


    borrowForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (scannedCodes.length === 0) { 
        alert('No books scanned to borrow'); 
        return; 
    }

    const borrowerId = document.getElementById('bId').value.trim();

    // Check if borrower has unreturned books
    const existing = serverRecords.find(r => r.borrower && r.borrower.id === borrowerId);
    if (existing) {
        alert("You must return your previous borrowed books before borrowing new ones.");
        return;
    }

    const record = {
        borrower: {
            name: document.getElementById('bName').value.trim(),
            id: borrowerId,
            email: document.getElementById('bEmail').value.trim(),
            phone: document.getElementById('bPhone').value.trim(),
            course: document.getElementById('bCourse').value.trim(),
            year: document.getElementById('bYear').value.trim(),
            dept: document.getElementById('bDept').value.trim()
        },
        books: scannedCodes,
        quantity: scannedCodes.length,                // Added quantity
        date: new Date().toLocaleDateString()        // Added borrow date
    };

    const res = await postJSON(ENDPOINTS.save, record);
    if (res && (res.status==='success' || res.ok===true)) {
        showToast('Borrow saved to server');
    } else {
        serverRecords.push(record);
        saveServerRecordsToLocal();
        showToast('Server unavailable — saved locally');
    }

    scannedCodes = [];
    localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
    renderScannedList();
    dlgBorrow.close();
    renderRecordsList();
});

    btnDone.addEventListener('click', ()=>{
  if(scannedCodes.length === 0) return;

  const inputId = document.getElementById('bId')?.value.trim() || '';
  if(inputId){
    // Check if this ID already has borrowed books not returned
    const existing = serverRecords.find(r => r.borrower && r.borrower.id === inputId);
    if(existing){
      showToast('This ID has unreturned books! Cannot borrow until returned.', 3000);
      return; // block borrow
    }
  }

  dlgScannedList.innerHTML = '';
  scannedCodes.forEach(c=>{
    const s = document.createElement('span'); 
    s.className='chip'; 
    s.textContent=c;
    dlgScannedList.appendChild(s);
  });
  dlgBorrow.showModal();
});


    btnCancelBorrow.addEventListener('click', ()=> dlgBorrow.close());
    btnRecords.addEventListener('click', async ()=>{
      dlgRecords.showModal();
      await loadServerRecords();
    });
    btnCloseRecords.addEventListener('click', ()=> dlgRecords.close());

    searchRecords.addEventListener('input', ()=>{
      const q = searchRecords.value.toLowerCase();
      Array.from(recordsList.children).forEach(li=>{
        const txt = li.dataset.search;
        li.style.display = txt.includes(q) ? '' : 'none';
      });
    });

    function renderRecordsList(){
    recordsList.innerHTML = '';
    if(serverRecords.length === 0){
        emptyState.textContent = 'No records';
        return;
    }
    emptyState.textContent = '';

    serverRecords.forEach(r => {
        const li = document.createElement('li');
        li.className = 'card';

        const borrower = r.borrower || {};
        const books = r.books || [];
        const qty = r.quantity || books.length;
        const date = r.date || '-';

        li.innerHTML = `
            <strong>Name:</strong> ${borrower.name || 'Unknown'}<br>
            <strong>ID:</strong> ${borrower.id || '-'}<br>
            <strong>Email:</strong> ${borrower.email || '-'}<br>
            <strong>Phone:</strong> ${borrower.phone || '-'}<br>
            <strong>Course:</strong> ${borrower.course || '-'}<br>
            <strong>Year:</strong> ${borrower.year || '-'}<br>
            <strong>Department:</strong> ${borrower.dept || '-'}<br>
            <strong>Borrowed Books:</strong> ${books.join(', ') || '-'}<br>
            <span class="muted small">Quantity: ${qty} • Borrowed: ${date}</span>
        `;

        li.dataset.search = `
            ${borrower.name || ''} ${borrower.id || ''} ${borrower.email || ''} 
            ${borrower.phone || ''} ${borrower.course || ''} ${borrower.year || ''} 
            ${borrower.dept || ''} ${books.join(' ')}
        `.toLowerCase();

        recordsList.appendChild(li);
    });
}


    btnCancelReturn.addEventListener('click', exitReturnMode);
    btnConfirmReturn.addEventListener('click', confirmReturn);

    btnStart.addEventListener('click', startScan);
    btnStop.addEventListener('click', stopScan);
    btnTorch.addEventListener('click', ()=>{
      if(!currentTrack) return;
      torchOn = !torchOn;
      currentTrack.applyConstraints({ advanced:[{torch:torchOn}] }).catch(e=>showToast('Torch not supported'));
    });

btnDone.addEventListener('click', () => {
    if (scannedCodes.length === 0) {
        showToast('No books scanned to borrow');
        return;
    }

    // Populate scanned books in dialog
    dlgScannedList.innerHTML = '';
    scannedCodes.forEach(c => {
        const s = document.createElement('span');
        s.className = 'chip';
        s.textContent = c;
        dlgScannedList.appendChild(s);
    });

    dlgScannedList.innerHTML = '';
scannedCodes.forEach(c => {
    const s = document.createElement('span');
    s.className = 'chip';
    s.textContent = c;
    dlgScannedList.appendChild(s);
});
const qtyEl = document.createElement('div');
qtyEl.style.marginTop = '0.4rem';
qtyEl.className = 'muted small';
qtyEl.textContent = `Quantity: ${scannedCodes.length}`;
dlgScannedList.appendChild(qtyEl);


    // Show borrower form
    dlgBorrow.showModal();
});

borrowForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (scannedCodes.length === 0) { 
        alert('No books scanned to borrow'); 
        return; 
    }

    const borrowerId = document.getElementById('bId').value.trim();

    // Check if borrower has unreturned books
    const existing = serverRecords.find(r => r.borrower && r.borrower.id === borrowerId);
    if (existing) {
        alert("You must return your previous borrowed books before borrowing new ones.");
        return;
    }

    // Save the borrow record
    const record = {
        borrower: {
            name: document.getElementById('bName').value.trim(),
            id: borrowerId,
            email: document.getElementById('bEmail').value.trim(),
            phone: document.getElementById('bPhone').value.trim(),
            course: document.getElementById('bCourse').value.trim(),
            year: document.getElementById('bYear').value.trim(),
            dept: document.getElementById('bDept').value.trim()
        },
        books: scannedCodes
    };

    // Try saving to server, fallback to local
    const res = await postJSON(ENDPOINTS.save, record);
    if (res && (res.status==='success' || res.ok===true)) {
        showToast('Borrow saved to server');
    } else {
        serverRecords.push(record);
        saveServerRecordsToLocal();
        showToast('Server unavailable — saved locally');
    }

    // Clear scanned codes
    scannedCodes = [];
    localStorage.setItem('scannedCodes', JSON.stringify(scannedCodes));
    renderScannedList();
    dlgBorrow.close();
    renderRecordsList();
});

    loadServerRecords();
  })();
  </script>
</body>
</html>


